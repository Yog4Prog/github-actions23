name: Github Actions Demo
on: 
  workflow_dispatch:
  push:
  
jobs:
  Example-Actions-Job:
    name: Exploring Github Actions
    runs-on: ubuntu-latest
    steps:
    - run: echo "Payload field is ${{ github.event.client_payload.mydata }}"
    # Display the event that triggered the workflow
    - run: echo "The job was triggerd by a ${{ github.event_name }} event."
    
    # Runner information
    - run: echo "This job is running on ${{ runner.os }} server hosted by GitHub."
    
    - name: Detect Node version
      run: | 
        node --version
     
    - name: Detect Npm version
      run: | 
        npm --version
    - name: Download Node 20 Version
      run: |
        curl -o node-v20.tar.xz https://nodejs.org/dist/v20.9.0/node-v20.9.0-linux-x64.tar.xz
    - name: Extract Node 
      run: |
        mkdir sw 
        tar -C sw -xf node-v20.tar.xz
        ls -ltr ${{ github.workspace }}
        cd sw/node-v20.9.0-linux-x64/bin
        ls -ltr
    - name: Detect Node20 version
      run: | 
        export PATH=/home/runner/work/github-actions23/github-actions23/sw/node-v20.9.0-linux-x64/bin:$PATH
        npm --version
        node --version
    - name: Setup Dotnet
      uses: actions/setup-dotnet@v3
      with: 
        dotnet-version: '7.0'

    - name: Checkout
      uses: actions/checkout@v4

    - name: Detect Package Name
      id: read-json
      run: |
        echo "packageConfig<<EOF" >> $GITHUB_OUTPUT
        cat ./package.json >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Print OUtput
      env: 
        PACKAGE_NAME: ${{ fromJson(steps.read-json.outputs.packageConfig).name }}
        PACKAGE_VERSION: ${{ fromJson(steps.read-json.outputs.packageConfig).version }}
      run: |
        echo "${{ fromJson(steps.read-json.outputs.packageConfig).version }}"
        echo "${{ fromJson(steps.read-json.outputs.packageConfig).name }}"
    - name: Build
      env: 
        FILETOPUB: ${{ env.PACKAGE_NAME }}. ${{ env.PACKAGE_VERSION }} .tgz
      run: | 
        echo "Package to Publish is ${{ fromJson(steps.read-json.outputs.packageConfig).name }}.${{ fromJson(steps.read-json.outputs.packageConfig).version }}.tgz"
        export PATH=/home/runner/work/github-actions23/github-actions23/sw/node-v20.9.0-linux-x64/bin:$PATH
        #curl -uraju4cloud:AP2PoNKU4AAE8jMYqWRq8URGHwr "https://studentwf.jfrog.io/artifactory/api/npm/npm-yoglib-local/auth/jfrog" > .npmrc
        curl -uraju4cloud1:AP7L5WkZYceUnSoVYZuGq6rRyi4 "https://studentwf.jfrog.io/artifactory/api/npm/student-home-npm/auth/jfrog" > .npmrc
        mkdir npm
        mv -f .npmrc npm/
        npm install --userconfig npm/.npmrc
        npm run build
        npm pack
        rm -f npm/.npmrc 
    
    - name: Build Dotnet Component
      id: dotnet-build
      run : |
        dotnet msbuild 'dotnetProj/build.proj'
        
    - name: Zip Dotnet Artifacts
      id: zip-dotnet-artifacts
      run: |
        zip -r dotnet-artifacts.zip dotnetProj/WebApp/bin/Debug/net7.0

    - name: Fetch Artifacts Name
      id: fan
      run : |
        
        file_extensions=("zip" "tgz" "nupkg" "json" "abc")
        
        found_files_zip=()
        found_files_tgz=()
        found_files_nupkg=()
        found_files_json=()
        found_files_abc=()
        

        for ext in "${file_extensions[@]}"; do
          files=$(find . -maxdepth 5 -type f -name "*.$ext")
          if [ -n "$files" ]; then
            case $ext in
              "zip")
                found_files_zip+=("$files")
                ;;
              "tgz")
                found_files_tgz+=("$files")
                ;;
              "nupkg")
                found_files_nupkg+=("$files")
               ;;
              "json")
                found_files_json+=("$files")
               ;;
              "abc")
                found_files_abc+=("$files")
               ;;
            esac
          fi
        done
        
        if [ ${#found_files_zip[@]} -gt 0 ]; then
          mkdir -p artifactsZip
          cp "${found_files_zip[@]}" "./artifactsZip/"
          ls ./artifactsZip
          zip -r artifactsZip.zip ./artifactsZip
        fi
     
        if [ ${#found_files_tgz[@]} -gt 0 ]; then
          mkdir -p artifactstgz
          cp "${found_files_tgz[@]}" "./artifactsTgz/"
          ls ./artifactsTgz
          zip -r artifactsTgz.zip ./artifactsTgz
        fi

        if [ ${#found_files_nupkg[@]} -gt 0 ]; then
          mkdir -p artifactsNupkg
          cp "${found_files_nupkg[@]}" "./artifactsNupkg/"
          ls ./artifactsNupkg
          zip -r artifactsNupkg.zip ./artifactsNupkg
        fi

        if [ ${#found_files_json[@]} -gt 0 ]; then
          mkdir -p artifactsJson
          cp "${found_files_json[@]}" "./artifactsJson/"
          ls ./artifactsJson
          zip -r artifactsJson.zip ./artifactsJson
        fi

        if [ ${#found_files_abc[@]} -gt 0 ]; then
          mkdir -p artifactsAbc
          cp "${found_files_abc[@]}" "./artifactsAbc/"
          ls ./artifactsAbc
          zip -r artifactsAbc.zip ./artifactsAbc
        fi

    - name: Publish
      run: | 
        export PATH=/home/runner/work/github-actions23/github-actions23/sw/node-v20.9.0-linux-x64/bin:$PATH
        #curl -uraju4cloud:AP2PoNKU4AAE8jMYqWRq8URGHwr "https://selfeducation.jfrog.io/artifactory/api/npm/npm-yoglib-local/auth/jfrog" > .npmrc
        #mv -f .npmrc npm/
        #cat npm/.npmrc
        # npm publish --registry https://selfeducation.jfrog.io/artifactory/api/npm/npm-yoglib-local/ --userconfig npm/.npmrc
        curl -v --user raju4cloud1:AP7L5WkZYceUnSoVYZuGq6rRyi4 -T artifacts.zip -X PUT -H 'X-Explode-Archive: true' "https://studentwf.jfrog.io/artifactory/student-home-npm/${{ fromJson(steps.read-json.outputs.packageConfig).version }}/"
   
    
    
    - name: Publish NPM Package
      run: | 
        export PATH=/home/runner/work/github-actions23/github-actions23/sw/node-v20.9.0-linux-x64/bin:$PATH
        #curl -uraju4cloud:AP2PoNKU4AAE8jMYqWRq8URGHwr "https://selfeducation.jfrog.io/artifactory/api/npm/npm-yoglib-local/auth/jfrog" > .npmrc
        #mv -f .npmrc npm/
        #cat npm/.npmrc
        # npm publish --registry https://selfeducation.jfrog.io/artifactory/api/npm/npm-yoglib-local/ --userconfig npm/.npmrc

   
